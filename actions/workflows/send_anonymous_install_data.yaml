---
  chain:
    -
      name: "check_for_permission_to_send_anonymous_data"
      ref: "st2.kv.get"
      params:
        key: "st2::collect_anonymous_data"
      on-success: "get_server_uuid"
    -
      name: "get_server_uuid"
      ref: "st2.kv.get"
      params:
        key: "st2::server_uuid"
      publish:
        server_uuid: "{{get_server_uuid.result}}"
      on-success: "generate_anonymous_data"
    -
      name: "generate_anonymous_data"
      ref: "core.local"
      params:
        cmd: "st2-submit-debug-info --exclude-configs --exclude-logs --exclude-content --review"
      on-success: "get_tarball_location"
    -
      name: "get_tarball_location"
      ref: "core.local"
      params:
        cmd: "echo {{generate_anonymous_data.result.stdout}} | awk '{print $(NF)}'"
      publish:
        tarball: "{{get_tarball_location.result.stdout}}"
      on-success: "upload_to_s3"
    -
      name: "upload_to_s3"
      ref: "core.local"
      params:
        cmd: "/opt/stackstorm/virtualenvs/st2/bin/s3 -c /opt/stackstorm/packs/st2/config.yaml -b st2express-install put {{tarball}} {{server_uuid}}.tar.gz"
